<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RaveRoom3D — Bem-vindo</title>
  <style>
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:#0a0a0a;color:#eee;overflow:hidden;}
    #ui{position:fixed;left:12px;top:12px;z-index:20;width:320px;background:rgba(0,0,0,0.5);padding:12px;border-radius:10px; display:none;}
    label{display:block;font-size:13px;margin-top:8px}
    input,select,button{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02);color:#fff}
    #canvas-container{width:100%;height:100%}
    .player-controls{display:flex;gap:8px;margin-top:8px}
    .small{padding:6px;font-size:13px}
    #peeps{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
    .pill{background:rgba(255,255,255,0.06);padding:6px 8px;border-radius:999px;font-size:13px}
    #help{font-size:12px;opacity:0.8;margin-top:8px}

    /* Welcome screen */
    #welcome-screen {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(10,10,10,0.95);
      display: flex; justify-content: center; align-items: center;
      z-index: 50; color: #fff; font-family: Inter, Arial, sans-serif;
    }
    #welcome-box {
      background: rgba(0,0,0,0.7); padding: 30px; border-radius: 15px; text-align: center; min-width: 280px;
    }
    #welcome-box h1 { margin-bottom: 20px; font-size: 24px; animation: fadeInDown 1s; }
    #welcome-box input, #welcome-box button, #welcome-box select { margin: 8px 0; width: 100%; padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #fff; }
    #welcome-box button { cursor: pointer; background: #ff3b3b; border: none; font-weight: bold; transition: 0.2s; }
    #welcome-box button:hover { background: #ff6666; }
    @keyframes fadeInDown { 0% { opacity:0; transform: translateY(-20px);} 100% { opacity:1; transform: translateY(0);} }
  </style>
</head>
<body>

  <!-- Welcome Overlay -->
  <div id="welcome-screen">
    <div id="welcome-box">
      <h1>Bem-vindo à RaveRoom3D!</h1>
      <label>Seu nome:</label>
      <input type="text" id="welcome-nick" placeholder="Digite seu nome"/>
      <label>Escolha uma cor para seu avatar:</label>
      <input type="color" id="welcome-color" value="#ff3b3b"/>
      <label>Escolha seu papel:</label>
      <select id="welcome-role">
        <option value="clubber">Clubber</option>
        <option value="dj">DJ</option>
      </select>
      <button id="enter-btn">Entrar na festa</button>
    </div>
  </div>

  <div id="ui">
    <strong>RaveRoom3D — Protótipo</strong>
    <label>Nome da sala (qualquer):<input id="room" value="minha-rave"/></label>
    <label>Você é host? (quem controla a reprodução):
      <select id="isHost"><option value="true">Sim (Host)</option><option value="false">Não (Convidado)</option></select>
    </label>
    <label>Fonte de áudio (DJ apenas, URL ou arquivo):<input id="audioUrl" placeholder="https://.../musica.mp3"/></label>
    <input id="file" type="file" accept="audio/*"/>
    <div class="player-controls">
      <button id="play" class="small">Play/Pause</button>
      <button id="seekBack" class="small">-5s</button>
      <button id="seekFwd" class="small">+5s</button>
    </div>
    <div id="peeps"></div>
    <div id="help">Abra este arquivo em várias abas do mesmo navegador para testar (BroadcastChannel). Para convidar amigos pela internet use uma backend (ex: Firebase) — instruções abaixo.</div>
  </div>

  <div id="canvas-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/examples/js/renderers/CSS2DRenderer.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded',()=>{

    // --- Variáveis de usuário ---
    let userNick = '';
    let userColor = '#ff3b3b';
    let userRole = 'clubber';

    // --- Elementos DOM ---
    const welcomeScreen = document.getElementById('welcome-screen');
    const enterBtn = document.getElementById('enter-btn');
    const welcomeNick = document.getElementById('welcome-nick');
    const welcomeColor = document.getElementById('welcome-color');
    const welcomeRole = document.getElementById('welcome-role');
    const uiPanel = document.getElementById('ui');

    // --- Three.js Setup ---
    const container = document.getElementById('canvas-container');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0,6,12);
    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x05050a);
    container.appendChild(renderer.domElement);

    const labelRenderer = new THREE.CSS2DRenderer();
    labelRenderer.setSize(window.innerWidth, window.innerHeight);
    labelRenderer.domElement.style.position='absolute';
    labelRenderer.domElement.style.top='0px';
    container.appendChild(labelRenderer.domElement);

    const controls = new THREE.OrbitControls(camera, labelRenderer.domElement);
    controls.enableDamping = true;

    // --- Cenário estilo boate ---
    const floor = new THREE.Mesh(new THREE.BoxGeometry(20,0.1,20), new THREE.MeshStandardMaterial({color:0x111111, metalness:0.3, roughness:0.7})); scene.add(floor);
    const stage = new THREE.Mesh(new THREE.BoxGeometry(6,0.6,4), new THREE.MeshStandardMaterial({color:0x222222, metalness:0.5, roughness:0.4})); stage.position.set(0,0.3,-5); scene.add(stage);
    const disco = new THREE.Mesh(new THREE.SphereGeometry(0.7,24,24), new THREE.MeshStandardMaterial({color:0xffffff, metalness:1, roughness:0.2})); disco.position.set(0,3.5,0); scene.add(disco);

    const avatars = {};

    // --- Audio ---
    const audio = new Audio(); audio.crossOrigin='anonymous'; audio.loop=false; audio.preload='auto';
    let audioContext, sourceNode, analyser;
    function setupAudioNodes(){ if(audioContext) return; audioContext=new (window.AudioContext||window.webkitAudioContext)(); sourceNode=audioContext.createMediaElementSource(audio); analyser=audioContext.createAnalyser(); analyser.fftSize=256; sourceNode.connect(analyser); analyser.connect(audioContext.destination); }

    // --- BroadcastChannel ---
    let channel;
    const roomInput = document.getElementById('room');
    const peepsDiv = document.getElementById('peeps');
    function joinChannel(){
      const roomName = 'raveroom|' + roomInput.value;
      if(channel) channel.close();
      channel = new BroadcastChannel(roomName);
      channel.onmessage = (ev)=>handleMessage(ev.data);
      send({type:'presence', nick:userNick, color:userColor});
    }
    function send(obj){ if(!channel) joinChannel(); obj.nick=userNick; channel.postMessage(obj); }
    function handleMessage(msg){ if(msg.type==='presence'){ addPeer(msg.nick,msg.color); } }
    function addPeer(name,color){ if(avatars[name]) return; const mat=new THREE.MeshStandardMaterial({color:new THREE.Color(color)}); const sphere=new THREE.Mesh(new THREE.SphereGeometry(0.5,16,16),mat); sphere.position.set(Object.keys(avatars).length%8-4,0.6,-Math.floor(Object.keys(avatars).length/8)-1); scene.add(sphere); avatars[name]={mesh:sphere}; refreshPeepsUI(); }
    function refreshPeepsUI(){ peepsDiv.innerHTML=''; for(const n of Object.keys(avatars)){ const el=document.createElement('span'); el.className='pill'; el.textContent=n; peepsDiv.appendChild(el); } }

    // --- Botão Entrar ---
    enterBtn.onclick = ()=>{
      userNick = welcomeNick.value.trim() || 'Convidado';
      userColor = welcomeColor.value;
      userRole = welcomeRole.value;
      welcomeScreen.style.display='none';
      uiPanel.style.display='block';
      addPeer(userNick,userColor);
      joinChannel();
      if(userRole==='dj'){ setupAudioNodes(); }
    };

    // --- Loop de animação ---
    function animate(t){ requestAnimationFrame(animate); disco.rotation.y+=0.01; controls.update(); renderer.render(scene,camera); labelRenderer.render(scene,camera); }
    animate();

    window.addEventListener('resize',()=>{ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); labelRenderer.setSize(window.innerWidth,window.innerHeight); });
  });
  </script>
</body>
</html>
