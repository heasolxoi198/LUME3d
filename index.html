<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RaveRoom3D — Bem-vindo</title>
  <style>
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:#0a0a0a;color:#eee;overflow:hidden;}
    #ui{position:fixed;left:12px;top:12px;z-index:20;width:320px;background:rgba(0,0,0,0.5);padding:12px;border-radius:10px}
    label{display:block;font-size:13px;margin-top:8px}
    input,select,button{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02);color:#fff}
    #canvas-container{width:100%;height:100%}
    .player-controls{display:flex;gap:8px;margin-top:8px}
    .small{padding:6px;font-size:13px}
    #peeps{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
    .pill{background:rgba(255,255,255,0.06);padding:6px 8px;border-radius:999px;font-size:13px}
    #help{font-size:12px;opacity:0.8;margin-top:8px}

    /* Welcome screen */
    #welcome-screen {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(10,10,10,0.95);
      display: flex; justify-content: center; align-items: center;
      z-index: 50; color: #fff; font-family: Inter, Arial, sans-serif;
    }
    #welcome-box {
      background: rgba(0,0,0,0.7); padding: 30px; border-radius: 15px; text-align: center; min-width: 280px;
    }
    #welcome-box h1 { margin-bottom: 20px; font-size: 24px; animation: fadeInDown 1s; }
    #welcome-box input, #welcome-box button { margin: 8px 0; width: 100%; padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #fff; }
    #welcome-box button { cursor: pointer; background: #ff3b3b; border: none; font-weight: bold; transition: 0.2s; }
    #welcome-box button:hover { background: #ff6666; }
    @keyframes fadeInDown { 0% { opacity:0; transform: translateY(-20px);} 100% { opacity:1; transform: translateY(0);} }
  </style>
</head>
<body>
  <!-- Welcome Overlay -->
  <div id="welcome-screen">
    <div id="welcome-box">
      <h1>Bem-vindo à RaveRoom3D!</h1>
      <label>Seu nome:</label>
      <input type="text" id="welcome-nick" placeholder="Digite seu nome"/>
      <label>Escolha uma cor para seu avatar:</label>
      <input type="color" id="welcome-color" value="#ff3b3b"/>
      <button id="enter-btn">Entrar na festa</button>
    </div>
  </div>

  <div id="ui">
    <strong>RaveRoom3D — Protótipo</strong>
    <label>Nome da sala (qualquer):<input id="room" value="minha-rave"/></label>
    <label>Você é host? (quem controla a reprodução):
      <select id="isHost"><option value="true">Sim (Host)</option><option value="false">Não (Convidado)</option></select>
    </label>
    <div id="peeps"></div>
    <div id="help">Abra este arquivo em várias abas do mesmo navegador para testar (BroadcastChannel). Para convidar amigos pela internet use a backend (ex: Firebase) — instruções abaixo.</div>
  </div>

  <div id="canvas-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/examples/js/renderers/CSS2DRenderer.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded',()=>{
    const container = document.getElementById('canvas-container');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0,6,12);
    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x05050a);
    container.appendChild(renderer.domElement);

    const labelRenderer = new THREE.CSS2DRenderer();
    labelRenderer.setSize(window.innerWidth, window.innerHeight);
    labelRenderer.domElement.style.position = 'absolute';
    labelRenderer.domElement.style.top = '0px';
    container.appendChild(labelRenderer.domElement);

    const controls = new THREE.OrbitControls(camera, labelRenderer.domElement);
    controls.enableDamping = true;

    // Floor, stage, disco ball, lights (igual ao protótipo anterior)
    const floor = new THREE.Mesh(new THREE.CircleGeometry(12,64), new THREE.MeshStandardMaterial({color:0x111111,metalness:0.3,roughness:0.6})); floor.rotation.x=-Math.PI/2; scene.add(floor);
    const stage = new THREE.Mesh(new THREE.CylinderGeometry(3.5,3.5,0.6,32), new THREE.MeshStandardMaterial({color:0x222222,metalness:0.5,roughness:0.4})); stage.position.y=0.3; scene.add(stage);
    const disco = new THREE.Mesh(new THREE.SphereGeometry(1.2,24,24), new THREE.MeshStandardMaterial({color:0xffffff, metalness:1, roughness:0.2})); disco.position.set(0,4,0); scene.add(disco);

    const amb = new THREE.AmbientLight(0xffffff,0.12); scene.add(amb);
    const pointL = new THREE.PointLight(0xff0040,1,30); pointL.position.set(5,6,5); scene.add(pointL);
    const pointR = new THREE.PointLight(0x0040ff,1,30); pointR.position.set(-5,6,5); scene.add(pointR);

    const lights=[]; for(let i=0;i<6;i++){ const l=new THREE.PointLight(0xffffff,1,20); scene.add(l); lights.push(l); }
    const avatars = {};

    // Audio setup
    const audio = new Audio(); audio.crossOrigin='anonymous'; audio.loop=false; audio.preload='auto';
    let audioContext, sourceNode, analyser;
    function setupAudioNodes(){ if(audioContext) return; audioContext=new (window.AudioContext||window.webkitAudioContext)(); sourceNode=audioContext.createMediaElementSource(audio); analyser=audioContext.createAnalyser(); analyser.fftSize=256; sourceNode.connect(analyser); analyser.connect(audioContext.destination); }

    const eqGroup = new THREE.Group(); scene.add(eqGroup);
    const eqCount=24; const eqGeo=new THREE.BoxGeometry(0.25,1,0.25);
    for(let i=0;i<eqCount;i++){ const m=new THREE.Mesh(eqGeo,new THREE.MeshStandardMaterial({color:0xff66ff})); m.position.x=(i-eqCount/2)*0.28; m.position.y=0.3; eqGroup.add(m); }
    eqGroup.position.y=0.6;

    // UI elements
    const $room = document.getElementById('room');
    const $isHost = document.getElementById('isHost');
    const $peeps = document.getElementById('peeps');

    // Networking
    let channel;
    function joinChannel(){ const roomName='raveroom|'+$room.value; if(channel) channel.close(); channel=new BroadcastChannel(roomName); channel.onmessage=(ev)=>handleMessage(ev.data); send({type:'presence',nick:$nick.value,color:$color.value}); if($isHost.value==='false') send({type:'request_state',nick:$nick.value}); }
    function send(obj){ if(!channel) joinChannel(); obj.nick=$nick.value; channel.postMessage(obj); }
    function handleMessage(msg){ if(msg.type==='presence'){ addPeer(msg.nick,msg.color); } }

    function addPeer(name,color){ if(avatars[name]) return; const mat=new THREE.MeshStandardMaterial({color:new THREE.Color(color)}); const sphere=new THREE.Mesh(new THREE.SphereGeometry(0.5,16,16),mat); const x=(Object.keys(avatars).length%8)-4; const z=Math.floor(Object.keys(avatars).length/8)*-1-1; sphere.position.set(x,0.6,z); scene.add(sphere); const div=document.createElement('div'); div.className='label'; div.textContent=name; div.style.padding='4px 8px'; div.style.background='rgba(0,0,0,0.5)'; const label=new THREE.CSS2DObject(div); label.position.set(0,0.8,0); sphere.add(label); avatars[name]={mesh:sphere,label:div}; refreshPeepsUI(); }
    function refreshPeepsUI(){ $peeps.innerHTML=''; for(const n of Object.keys(avatars)){ const el=document.createElement('span'); el.className='pill'; el.textContent=n; $peeps.appendChild(el); } }

    // Welcome screen logic
    const welcomeScreen=document.getElementById('welcome-screen');
    const enterBtn=document.getElementById('enter-btn');
    const welcomeNick=document.getElementById('welcome-nick');
    const welcomeColor=document.getElementById('welcome-color');

    const $nick = { value: 'Host' };
    const $color = { value: '#ff3b3b' };

    enterBtn.onclick=()=>{
      $nick.value=welcomeNick.value.trim()||'Convidado';
      $color.value=welcomeColor.value;
      addPeer($nick.value,$color.value);
      welcomeScreen.style.display='none';
      joinChannel();
    };

    // Animation loop
    const freqData=new Uint8Array(128);
    function animate(t){ requestAnimationFrame(animate); disco.rotation.y+=0.01; for(let i=0;i<lights.length;i++){ const a=t/1000+i*0.9; lights[i].position.set(Math.cos(a)*6,2+Math.sin(a*1.3)*1.5,Math.sin(a)*6); lights[i].intensity=0.8+Math.sin(a*2)*0.6; lights[i].color.setHSL((t/1000*0.08+i*0.1)%1,0.8,0.5); } if(analyser){ analyser.getByteFrequencyData(freqData); for(let i=0;i<eqCount;i++){ const v=freqData[i*2]/255; eqGroup.children[i].scale.y=0.2+v*6; eqGroup.children[i].position.y=0.3+eqGroup.children[i].scale.y/2; } } controls.update(); renderer.render(scene,camera); labelRenderer.render(scene,camera); }
    animate();

    window.addEventListener('resize',()=>{ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); labelRenderer.setSize(window.innerWidth,window.innerHeight); });
  });
  </script>
</body>
</html>
